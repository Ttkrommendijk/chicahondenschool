---
import { getLangFromUrl, localize } from "../i18n";
import { ui } from "../data/ui";

type DirectCta = {
    kind: "direct";
    label: string;
    href: string;
    external?: boolean;
};

type SelectableOption = {
    id: string;
    label: string;
    href?: string;
    external?: boolean;
    price?: string;
};

type LocationCta = {
    kind: "location";
    label: string;
    options: SelectableOption[];
};

type SelectorCta = {
    kind: "selector";
    label: string;
    selectorLabel: string;
    unavailableLabel: string;
    options: SelectableOption[];
};

type CardCta = DirectCta | LocationCta | SelectorCta;

interface Props {
    sectionId?: string;
    title: string;
    titleKey?: string;
    variant?: "default" | "priced";
    actionLink?: { label: string; href: string };
    actionLinkLabelKey?: string;
    items: Array<{
        title: string;
        description: string;
        href: string;
        image?: string;
        imageAlt?: string;
        ctaLabel?: string;
        badge?: string;
        titleKey?: string;
        descriptionKey?: string;
        ctaLabelKey?: string;
        badgeKey?: string;
        priceLabel?: string;
        headerTone?: "secondary" | "main";
        cta?: CardCta;
    }>;
}

const {
    sectionId,
    title,
    titleKey,
    items,
    variant = "default",
    actionLink,
    actionLinkLabelKey,
} = Astro.props as Props;
const lang = getLangFromUrl(Astro.url);
const hasInteractiveCta = items.some(
    (item) => item.cta && item.cta.kind !== "direct",
);

function resolveHref(href: string, title: string): string {
    if (href && href.trim().length > 0) {
        return href;
    }
    if (import.meta.env.DEV) {
        console.warn(
            `[ServiceCards] Missing href for service card "${title}". Falling back to "#".`,
        );
    }
    return "#";
}
---

<section id={sectionId} class="py-14 md:py-20">
    <div class="mx-auto w-full max-w-6xl px-4 md:px-6">
        <div class="flex flex-wrap items-end justify-between gap-3">
            <h2
                class="text-3xl font-bold tracking-tight text-secondary md:text-4xl"
            >
                {titleKey ? <span data-i18n={titleKey}>{title}</span> : title}
            </h2>
            {
                actionLink && (
                    <a
                        href={actionLink.href}
                        class="inline-flex items-center rounded-full border border-secondary bg-white px-5 py-2.5 text-sm font-semibold text-secondary transition hover:bg-secondary-soft focus:outline-none focus-visible:ring-2 focus-visible:ring-main"
                    >
                        {actionLinkLabelKey ? (
                            <span data-i18n={actionLinkLabelKey}>
                                {actionLink.label}
                            </span>
                        ) : (
                            actionLink.label
                        )}
                    </a>
                )
            }
        </div>
        <div class="mt-8 grid gap-6 md:grid-cols-2">
            {
                items.map((item, index) => {
                    const href = resolveHref(item.href, item.title);
                    const cta = item.cta;
                    const selectableOptions =
                        cta && cta.kind !== "direct" ? cta.options : [];
                    const firstAvailableOption =
                        selectableOptions.find((option) => Boolean(option.href)) ??
                        selectableOptions[0];

                    const ctaBlock = cta ? (
                        cta.kind === "direct" ? (
                            <a
                                href={cta.href}
                                target={cta.external === true ? "_blank" : undefined}
                                rel={
                                    cta.external === true
                                        ? "noopener noreferrer"
                                        : undefined
                                }
                                class="inline-flex items-center rounded-full bg-secondary px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-secondary-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-main"
                            >
                                {cta.label}
                            </a>
                        ) : (
                            <div
                                class="space-y-2"
                                data-card-cta-root
                                data-available-label={cta.label}
                                data-unavailable-label={
                                    cta.kind === "selector"
                                        ? cta.unavailableLabel
                                        : cta.label
                                }
                            >
                                {cta.kind === "selector" && (
                                    <label class="block text-sm font-semibold text-secondary">
                                        {cta.selectorLabel}
                                    </label>
                                )}
                                <select
                                    class="w-full rounded-xl border border-secondary/25 bg-white px-3 py-2 text-sm text-text focus:border-secondary focus:outline-none focus-visible:ring-2 focus-visible:ring-main"
                                    data-card-cta-select
                                >
                                    {selectableOptions.map((option) => (
                                        <option
                                            value={option.id}
                                            data-href={option.href ?? ""}
                                            data-external={
                                                option.external === true
                                                    ? "true"
                                                    : "false"
                                            }
                                            selected={
                                                option.id === firstAvailableOption?.id
                                            }
                                        >
                                            {option.label}
                                            {cta.kind === "selector" && option.price
                                                ? ` - ${option.price}`
                                                : ""}
                                        </option>
                                    ))}
                                </select>
                                <a
                                    href={firstAvailableOption?.href ?? "#"}
                                    target={
                                        firstAvailableOption?.href &&
                                        firstAvailableOption.external === true
                                            ? "_blank"
                                            : undefined
                                    }
                                    rel={
                                        firstAvailableOption?.href &&
                                        firstAvailableOption.external === true
                                            ? "noopener noreferrer"
                                            : undefined
                                    }
                                    aria-disabled={
                                        firstAvailableOption?.href
                                            ? undefined
                                            : "true"
                                    }
                                    class:list={[
                                        "inline-flex items-center rounded-full bg-secondary px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-secondary-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-main",
                                        !firstAvailableOption?.href &&
                                            "pointer-events-none opacity-60",
                                    ]}
                                    data-card-cta-button
                                >
                                    {firstAvailableOption?.href
                                        ? cta.label
                                        : cta.kind === "selector"
                                          ? cta.unavailableLabel
                                          : cta.label}
                                </a>
                            </div>
                        )
                    ) : (
                        <a
                            href={href}
                            class="inline-flex items-center rounded-full bg-secondary px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-secondary-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-main"
                        >
                            {item.ctaLabel ?? localize(ui.common.viewService, lang)}
                        </a>
                    );

                    if (variant === "priced") {
                        const headerIsMain = item.headerTone
                            ? item.headerTone === "main"
                            : index % 3 === 1;
                        return (
                            <article class="overflow-hidden rounded-3xl border border-secondary/20 bg-white shadow-sm transition hover:-translate-y-1 hover:shadow-lg">
                                <div
                                    class:list={[
                                        "flex justify-end px-5 py-3",
                                        headerIsMain
                                            ? "bg-main text-text"
                                            : "bg-secondary text-white",
                                    ]}
                                >
                                    <p class="text-base font-extrabold md:text-lg">
                                        {item.priceLabel}
                                    </p>
                                </div>
                                <div class="space-y-4 p-6">
                                    <h3 class="text-2xl font-bold text-secondary">
                                        {item.titleKey ? (
                                            <span data-i18n={item.titleKey}>
                                                {item.title}
                                            </span>
                                        ) : (
                                            item.title
                                        )}
                                    </h3>
                                    <p class="text-text">
                                        {item.descriptionKey ? (
                                            <span data-i18n={item.descriptionKey}>
                                                {item.description}
                                            </span>
                                        ) : (
                                            item.description
                                        )}
                                    </p>
                                    {ctaBlock}
                                </div>
                            </article>
                        );
                    }

                    return (
                        <article
                            class:list={[
                                "group overflow-hidden rounded-3xl border shadow-sm transition hover:-translate-y-1 hover:shadow-xl",
                                index % 2 === 0
                                    ? "border-secondary/35 bg-secondary-soft hover:border-secondary"
                                    : "border-main-hover/50 bg-main-soft hover:border-detail",
                            ]}
                        >
                            {(item.badge || item.priceLabel) && (
                                <div
                                    class:list={[
                                        "px-5 py-3",
                                        index % 2 === 0
                                            ? "bg-gradient-to-r from-secondary to-secondary-hover"
                                            : "bg-gradient-to-r from-detail to-secondary",
                                    ]}
                                >
                                    {item.badge && (
                                        <p class="text-xs font-semibold uppercase tracking-[0.15em] text-white">
                                            {item.badgeKey ? (
                                                <span data-i18n={item.badgeKey}>
                                                    {item.badge}
                                                </span>
                                            ) : (
                                                item.badge
                                            )}
                                        </p>
                                    )}
                                </div>
                            )}
                            {item.image && (
                                <img
                                    class="h-56 w-full object-cover transition duration-300 group-hover:scale-[1.02]"
                                    src={item.image}
                                    alt={item.imageAlt ?? item.title}
                                    loading="lazy"
                                />
                            )}
                            <div class="space-y-4 p-6">
                                <h3 class="text-2xl font-bold text-secondary">
                                    {item.titleKey ? (
                                        <span data-i18n={item.titleKey}>
                                            {item.title}
                                        </span>
                                    ) : (
                                        item.title
                                    )}
                                </h3>
                                <p class="text-text">
                                    {item.descriptionKey ? (
                                        <span data-i18n={item.descriptionKey}>
                                            {item.description}
                                        </span>
                                    ) : (
                                        item.description
                                    )}
                                </p>
                                {ctaBlock}
                            </div>
                        </article>
                    );
                })
            }
        </div>
    </div>
</section>

{
    hasInteractiveCta && (
        <script is:inline>
            (() => {
                const roots = document.querySelectorAll("[data-card-cta-root]");
                roots.forEach((root) => {
                    if (!(root instanceof HTMLElement)) return;
                    if (root.dataset.ctaBound === "true") return;
                    root.dataset.ctaBound = "true";

                    const select = root.querySelector("[data-card-cta-select]");
                    const button = root.querySelector("[data-card-cta-button]");
                    if (!(select instanceof HTMLSelectElement)) return;
                    if (!(button instanceof HTMLAnchorElement)) return;

                    const availableLabel =
                        root.getAttribute("data-available-label") ?? "";
                    const unavailableLabel =
                        root.getAttribute("data-unavailable-label") ?? "";

                    const applyState = () => {
                        const selected = select.options[select.selectedIndex];
                        const href = selected?.dataset.href ?? "";
                        const external = selected?.dataset.external === "true";
                        const isAvailable = href.length > 0;

                        button.textContent = isAvailable
                            ? availableLabel
                            : unavailableLabel;

                        if (isAvailable) {
                            button.href = href;
                            if (external) {
                                button.target = "_blank";
                                button.rel = "noopener noreferrer";
                            } else {
                                button.removeAttribute("target");
                                button.removeAttribute("rel");
                            }
                            button.removeAttribute("aria-disabled");
                            button.classList.remove(
                                "pointer-events-none",
                                "opacity-60",
                            );
                        } else {
                            button.removeAttribute("href");
                            button.removeAttribute("target");
                            button.removeAttribute("rel");
                            button.setAttribute("aria-disabled", "true");
                            button.classList.add(
                                "pointer-events-none",
                                "opacity-60",
                            );
                        }
                    };

                    select.addEventListener("change", applyState);
                    applyState();
                });
            })();
        </script>
    )
}
