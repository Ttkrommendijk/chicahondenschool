---
import LanguageSwitch from "./LanguageSwitch.astro";
import { localize, type Lang } from "../i18n";
import { ui } from "../data/ui";
import { dienstenIndexPage, services } from "../data/diensten";

interface Props {
    lang: Lang;
}

const { lang } = Astro.props as Props;

const normalizePath = (value: string) => {
    if (!value || value === "/") return "/";
    return value.endsWith("/") ? value : `${value}/`;
};

const pathname = normalizePath(Astro.url.pathname);
const isActive = (href: string) => pathname === normalizePath(href);
const isServicesActive =
    pathname.startsWith("/diensten/") ||
    pathname.startsWith("/hondenschool/") ||
    pathname.startsWith("/oppas-uitlaatservice/");
const topNavItemClass = "nav-link";
const subNavItemClass = "nav-sublink";
const topNavStateClass = (active: boolean) =>
    `${topNavItemClass} ${active ? "is-active" : ""}`;
const subNavStateClass = (active: boolean) =>
    `${subNavItemClass} ${active ? "is-active" : ""}`;

const serviceGroups = dienstenIndexPage.categories.map((category) => ({
    slug: category.slug,
    href: category.href,
    label: localize(category.title, lang),
    services: services.filter((service) => service.category === category.slug),
}));
---

<header class="site-header">
    <div class="container header-inner">
        <a class="brand brand-link" href="/">
            <img
                class="brand-logo"
                src="/images/logo-chica-hondenschool.jpg"
                alt={localize(ui.common.brandName, lang)}
            />
            <span>{localize(ui.common.brandName, lang)}</span>
        </a>
        <input id="nav-toggle" type="checkbox" hidden />
        <label
            class="menu-toggle"
            for="nav-toggle"
            aria-label={localize(ui.navigation.openNavigation, lang)}
            data-i18n-attr="aria-label:ui.navigation.openNavigation"
            ><span data-i18n="ui.navigation.menu"
                >{localize(ui.navigation.menu, lang)}</span
            ></label
        >
        <nav
            class="site-nav"
            aria-label={localize(ui.navigation.mainLabel, lang)}
            data-i18n-attr="aria-label:ui.navigation.mainLabel"
        >
            <ul class="nav-list">
                <li>
                    <a class={topNavStateClass(isActive("/"))} href="/"
                        ><span data-i18n="ui.navigation.home"
                            >{localize(ui.navigation.home, lang)}</span
                        ></a
                    >
                </li>
                <li>
                    <details class="services-menu">
                        <summary class={topNavStateClass(isServicesActive)}>
                            <span data-i18n="ui.navigation.services"
                                >{localize(ui.navigation.services, lang)}</span
                            >
                            <span
                                class="services-chevron services-root-chevron"
                                aria-hidden="true">&#9662;</span
                            >
                        </summary>
                        <div class="services-dropdown vertical-dropdown">
                            <ul class="services-groups" role="list">
                                {
                                    serviceGroups.map((group) => {
                                        const categoryActive =
                                            pathname.startsWith(
                                                normalizePath(group.href),
                                            );
                                        const hasActiveService =
                                            group.services.some((service) =>
                                                pathname.startsWith(
                                                    normalizePath(service.href),
                                                ),
                                            );
                                        const panelId = `services-panel-${group.slug}`;
                                        const shouldOpenByDefault =
                                            categoryActive || hasActiveService;

                                        return (
                                            <li class="services-group">
                                                <div class="services-group-header">
                                                    <a
                                                        class={subNavStateClass(
                                                            categoryActive ||
                                                                hasActiveService,
                                                        )}
                                                        href={group.href}
                                                    >
                                                        <span>
                                                            {group.label}
                                                        </span>
                                                    </a>
                                                    <button
                                                        type="button"
                                                        class="services-group-toggle"
                                                        aria-expanded={
                                                            shouldOpenByDefault
                                                                ? "true"
                                                                : "false"
                                                        }
                                                        aria-controls={panelId}
                                                    >
                                                        <span class="sr-only">
                                                            {group.label}
                                                        </span>
                                                        <span
                                                            class="services-chevron"
                                                            aria-hidden="true"
                                                        >
                                                            &#9662;
                                                        </span>
                                                    </button>
                                                </div>
                                                <div
                                                    id={panelId}
                                                    class:list={[
                                                        "subservices-panel",
                                                        shouldOpenByDefault &&
                                                            "is-open",
                                                    ]}
                                                >
                                                    <ul
                                                        class="subservices-list"
                                                        role="list"
                                                    >
                                                        {group.services.map(
                                                            (service) => (
                                                                <li>
                                                                    <a
                                                                        class={subNavStateClass(
                                                                            isActive(
                                                                                service.href,
                                                                            ),
                                                                        )}
                                                                        href={
                                                                            service.href
                                                                        }
                                                                    >
                                                                        {localize(
                                                                            service.title,
                                                                            lang,
                                                                        )}
                                                                    </a>
                                                                </li>
                                                            ),
                                                        )}
                                                    </ul>
                                                </div>
                                            </li>
                                        );
                                    })
                                }
                            </ul>
                        </div>
                    </details>
                </li>
                <li>
                    <a
                        class={topNavStateClass(isActive("/reviews/"))}
                        href="/reviews/"
                    >
                        <span data-i18n="ui.navigation.reviews"
                            >{localize(ui.navigation.reviews, lang)}</span
                        >
                    </a>
                </li>
                <li>
                    <a
                        class={topNavStateClass(isActive("/over/"))}
                        href="/over/"
                    >
                        <span data-i18n="ui.navigation.about"
                            >{localize(ui.navigation.about, lang)}</span
                        >
                    </a>
                </li>
                <li>
                    <a
                        class={topNavStateClass(isActive("/contact/"))}
                        href="/contact/"
                    >
                        <span data-i18n="ui.navigation.contact"
                            >{localize(ui.navigation.contact, lang)}</span
                        >
                    </a>
                </li>
                <li>
                    <LanguageSwitch
                        lang={lang}
                        pathname={Astro.url.pathname}
                        search={Astro.url.search}
                    />
                </li>
            </ul>
        </nav>
    </div>
</header>

<script>
    const INIT_KEY = "__chicaHeaderNavCleanup";
    const windowWithCleanup = window as Window & {
        [INIT_KEY]?: () => void;
    };
    windowWithCleanup[INIT_KEY]?.();

    const header = document.querySelector<HTMLElement>(".site-header");
    if (!header) {
        windowWithCleanup[INIT_KEY] = undefined;
    } else {
        const mobileMediaQuery = window.matchMedia("(max-width: 900px)");
        const servicesMenus = Array.from(
            header.querySelectorAll<HTMLElement>(".services-menu"),
        );
        const siteNav = header.querySelector<HTMLElement>(".site-nav");
        const navToggle = header.querySelector<HTMLInputElement>("#nav-toggle");
        const navToggleLabel =
            header.querySelector<HTMLElement>(".menu-toggle");
        const menuLinks = Array.from(
            header.querySelectorAll<HTMLAnchorElement>(".site-nav a"),
        );
        const pointerEventName =
            "onpointerdown" in window ? "pointerdown" : "mousedown";
        let outsideHandlerAttached = false;

        const closeMenus = () => {
            if (navToggle) navToggle.checked = false;
            for (const menu of servicesMenus) {
                const details = menu as HTMLDetailsElement;
                details.open = false;
            }
        };

        const isMenuOpen = () =>
            Boolean(navToggle?.checked) ||
            servicesMenus.some((menu) => (menu as HTMLDetailsElement).open);

        const onDocumentPointerDown = (event: Event) => {
            if (!isMenuOpen()) return;
            const target = event.target;
            if (!(target instanceof Node)) return;
            const clickedInsideNav = siteNav?.contains(target) ?? false;
            const clickedMenuToggle =
                navToggleLabel?.contains(target) || navToggle?.contains(target);
            if (clickedInsideNav || clickedMenuToggle) return;
            closeMenus();
        };

        const syncOutsideHandler = () => {
            if (isMenuOpen() && !outsideHandlerAttached) {
                document.addEventListener(
                    pointerEventName,
                    onDocumentPointerDown,
                    true,
                );
                outsideHandlerAttached = true;
                return;
            }

            if (!isMenuOpen() && outsideHandlerAttached) {
                document.removeEventListener(
                    pointerEventName,
                    onDocumentPointerDown,
                    true,
                );
                outsideHandlerAttached = false;
            }
        };

        const closeOtherGroups = (
            currentButton: HTMLButtonElement,
            allButtons: HTMLButtonElement[],
        ) => {
            for (const button of allButtons) {
                if (button === currentButton) continue;
                const panelId = button.getAttribute("aria-controls");
                if (!panelId) continue;
                const panel = document.getElementById(panelId);
                if (!panel) continue;
                button.setAttribute("aria-expanded", "false");
                panel.classList.remove("is-open");
            }
        };

        const cleanupTasks: Array<() => void> = [];

        for (const menu of servicesMenus) {
            const groupButtons = Array.from(
                menu.querySelectorAll<HTMLButtonElement>(
                    ".services-group-toggle",
                ),
            );

            for (const button of groupButtons) {
                const onToggleClick = () => {
                    const panelId = button.getAttribute("aria-controls");
                    if (!panelId) return;
                    const panel = document.getElementById(panelId);
                    if (!panel) return;
                    const nextExpanded =
                        button.getAttribute("aria-expanded") !== "true";

                    if (mobileMediaQuery.matches && nextExpanded) {
                        closeOtherGroups(button, groupButtons);
                    }

                    button.setAttribute(
                        "aria-expanded",
                        nextExpanded ? "true" : "false",
                    );
                    panel.classList.toggle("is-open", nextExpanded);
                };

                button.addEventListener("click", onToggleClick);
                cleanupTasks.push(() =>
                    button.removeEventListener("click", onToggleClick),
                );
            }

            const onMenuKeydown = (event: KeyboardEvent) => {
                if (event.key !== "Escape") return;
                const details = menu.closest("details");
                if (!(details instanceof HTMLDetailsElement)) return;
                details.open = false;
                syncOutsideHandler();
            };
            menu.addEventListener("keydown", onMenuKeydown);
            cleanupTasks.push(() =>
                menu.removeEventListener("keydown", onMenuKeydown),
            );

            const onMenuToggle = () => syncOutsideHandler();
            menu.addEventListener("toggle", onMenuToggle);
            cleanupTasks.push(() =>
                menu.removeEventListener("toggle", onMenuToggle),
            );
        }

        if (navToggle) {
            const onNavToggleChange = () => syncOutsideHandler();
            navToggle.addEventListener("change", onNavToggleChange);
            cleanupTasks.push(() =>
                navToggle.removeEventListener("change", onNavToggleChange),
            );
        }

        for (const link of menuLinks) {
            const onLinkClick = () => {
                closeMenus();
                syncOutsideHandler();
            };
            link.addEventListener("click", onLinkClick);
            cleanupTasks.push(() =>
                link.removeEventListener("click", onLinkClick),
            );
        }

        syncOutsideHandler();

        windowWithCleanup[INIT_KEY] = () => {
            for (const task of cleanupTasks) task();
            if (outsideHandlerAttached) {
                document.removeEventListener(
                    pointerEventName,
                    onDocumentPointerDown,
                    true,
                );
            }
            outsideHandlerAttached = false;
        };
    }
</script>
